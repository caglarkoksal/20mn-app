<!DOCTYPE html>
<html>
<head>
  <title>My Map</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css">
</head>
<body>
  <div id="map" style="height: 100vh;"></div>

  <div id="service-selection">
    <label><input type="checkbox" id="pharmacy" checked> Pharmacy</label>
    <label><input type="checkbox" id="library" checked> Library</label>
    <label><input type="checkbox" id="post_office" checked> Post Office</label>
    <label><input type="checkbox" id="bus_stop" checked> Bus Stop</label>
    <label><input type="checkbox" id="retail" checked> Retail</label>
    <label><input type="checkbox" id="doctor" checked> Doctor</label>
  </div>

  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <script>
    var map = L.map("map", {
      center: [51.5074, -0.1278], // London, UK (default center)
      zoom: 13 // default zoom level
    });

    var tileLayer = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "Map data Â© <a href='https://www.openstreetmap.org/'>OpenStreetMap</a> contributors"
    });
    tileLayer.addTo(map);

    var geoJsonLayer;

    function fetchData() {
      if (geoJsonLayer) {
        map.removeLayer(geoJsonLayer);
      }
      
      var bbox = map.getBounds().toBBoxString();
      var url = "https://overpass-api.de/api/interpreter?data=[out:json][timeout:25];(node['amenity'='pharmacy'](" + bbox + ");node['amenity'='library'](" + bbox + ");node['amenity'='post_office'](" + bbox + ");node['amenity'='bus_stop'](" + bbox + ");node['shop'='retail'](" + bbox + ");node['healthcare'='doctor'](" + bbox + "););out body;>;out skel qt;";
      var xmlhttp = new XMLHttpRequest();

    xmlhttp.onreadystatechange = () => {
  if (xmlhttp.readyState === 4 && xmlhttp.status === 200) {
    var data = JSON.parse(xmlhttp.responseText);

    geoJsonLayer = L.geoJSON(data, {
      pointToLayer: (feature, latlng) => {
        var iconUrl = "icons/" + feature.properties.amenity + ".png";
        var iconSize = [32, 32];
        var iconAnchor = [16, 16];
        var icon = L.icon({
          iconUrl: iconUrl,
          iconSize: iconSize,
          iconAnchor: iconAnchor
        });
        var marker = L.marker(latlng, { icon: icon });
        marker.bindPopup(feature.properties.name);
        return marker;
      }
    });
    geoJsonLayer.addTo(map);
  }
};
